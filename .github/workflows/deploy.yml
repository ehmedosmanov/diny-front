name: Deploy to Production

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Telegram notify (start)
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode=Markdown \
          -d text="*Deploy started*%0A%0ARepo: ${{ github.repository }}%0ABranch: master%0ACommit: ${{ github.sha }}"

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          command_timeout: 30m
          timeout: 30m
          script: |
            set -e
            
            # –ó–∞–≥—Ä—É–∑–∫–∞ NVM
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
            
            echo "=== Node version ==="
            node -v
            npm -v
            
            echo "=== Enter project directory ==="
            cd /var/www/html/front
            
            echo "=== Pull latest code ==="
            git pull origin master
            
            echo "=== Remove node_modules (if exists) ==="
            rm -rf node_modules
            
            echo "=== Install dependencies ==="
            NODE_OPTIONS="--max-old-space-size=1024" npm install --production --no-audit --no-fund --loglevel=verbose
            
            echo "=== Build project ==="
            NODE_OPTIONS="--max-old-space-size=1024" npm run build
            
            echo "=== Restart PM2 ==="
            pm2 restart front --update-env || pm2 start npm --name front -- run start
            
            echo "=== PM2 status ==="
            pm2 status
            
            echo "=== Health check ==="
            sleep 3
            curl -f http://127.0.0.1:3000/en || echo "Health check failed"

      - name: Telegram notify (success)
        if: success()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode=Markdown \
          -d text="‚úÖ *Deploy successful!*%0A%0Aüåç https://diny.az%0AüöÄ App is live"

      - name: Telegram notify (failure)
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode=Markdown \
          -d text="‚ùå *Deploy failed*%0A%0A‚ö†Ô∏è Check GitHub Actions logs"