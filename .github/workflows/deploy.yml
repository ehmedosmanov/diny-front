name: Deploy to Production

on:
  push:
    branches:
      - master
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Telegram notify (start)
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode=Markdown \
          -d text="*Deploy started*\n\n Repo: ${{ github.repository }}\n Branch: master\n Commit: ${{ github.sha }}"
      - name: Debug SSH key length
        run: |
            echo "KEY LENGTH:"
            echo "${{ secrets.SSH_PRIVATE_KEY }}" | wc -c

      - name: Test SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: root
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script: |
            whoami
            hostname
      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e

            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"

            echo "Node version:"
            node -v
            npm -v

            echo "Enter project directory"
            cd /var/www/html/front

            echo "‚¨áPull latest code"
            git pull origin master

            echo "Install dependencies"
            npm ci

            echo "Build project"
            npm run build

            echo "Restart PM2"
            pm2 restart front --update-env || pm2 start npm --name front -- run start

            echo "PM2 status"
            pm2 status
      - name: Telegram notify (success)
        if: success()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode=Markdown \
          -d text="‚úÖ *Deploy successful!*\n\nüåç https://diny.az\nüöÄ App is live"
      - name: Telegram notify (failure)
        if: failure()
        run: |
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode=Markdown \
          -d text="‚ùå *Deploy failed*\n\n‚ö†Ô∏è Check GitHub Actions logs"
